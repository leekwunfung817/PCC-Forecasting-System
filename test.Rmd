---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---
```{r}
knitr::opts_chunk$set(fig.path = "./test/")



# Load required packages
library(RMySQL)
library(ggplot2)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggpubr)


# Database connection
con <- dbConnect(MySQL(),
                user = "pcc-sdr",         # Replace with your MySQL username
                password = "6zu_.Ldx2.zCNb_8",         # Replace with your MySQL password
                dbname = "pcc_forecast_db",
                host = "127.0.0.1")

# Fetch data from all tables
accom_data <- dbGetQuery(con, "
SELECT * FROM `htaaccommodationchoices`
where 1=1
	and `value` is not null
  and `value`>0
;
")

air_data <- dbGetQuery(con, "
SELECT * FROM `htaallvisitorsbyair` 
WHERE 1=1
	and `value` is not null
  and `value` > 0
;")

travel_data <- dbGetQuery(con, "SELECT * FROM htamethoodoftrave")

purpose_data <- dbGetQuery(con, "
SELECT * FROM `htapurposeoftrip` WHERE 1=1
  and `value` is not null 
  and `value`>0
;
")

ticket_data <- dbGetQuery(con, " 
SELECT * FROM htaticketing 
WHERE 1=1
  AND DATE_FORMAT(STR_TO_DATE(CONCAT(year,'-',month,'-01'), '%Y-%M-%d'), '%Y-%m') < DATE_FORMAT(NOW(), '%Y-%m')
  AND TicketSell > 0
  AND TicketSell IS NOT NULL
;
")
ticket_data

tenant_data <- dbGetQuery(con, "
SELECT * FROM tenantsales
where 1=1
  and `Net Sales` >0
  and `Net Sales` is not null
;
")

```

```{r}

```


```{r}
# Prepare ticket_data with a month-year column
if(nrow(ticket_data) > 0) {
  ticket_data$date <- as.Date(paste(ticket_data$Year, ticket_data$Month, "01", sep = "-"), format = "%Y-%B-%d")
  ticket_data$month_year <- format(ticket_data$date, "%Y-%m")
  ticket_sum <- ticket_data %>% 
    group_by(month_year) %>% 
    summarise(total_tickets = sum(TicketSell, na.rm = TRUE))
}

# Function to calculate and plot correlation
plot_correlation <- function(data1, data2, x_var, y_var, title, group_var = NULL) {
  if(nrow(data1) > 0 && nrow(data2) > 0) {
    # Merge data by month_year
    merged_data <- merge(data1, data2, by = "month_year", all = FALSE)
    
    # Calculate correlation
    cor_value <- cor(merged_data[[x_var]], merged_data[[y_var]], use = "complete.obs", method = "pearson")
    cat(sprintf("%s - Pearson Correlation: %.3f\n", title, cor_value))
    
    # Create scatter plot
    if(is.null(group_var)) {
      p <- ggplot(merged_data, aes_string(x = x_var, y = y_var, label = "month_year")) +
        geom_point() +
        geom_smooth(method = "lm", color = "blue") +
        geom_text(check_overlap = TRUE, vjust = 1.5, size = 3) +
        labs(title = title, x = "Ticket Sales", y = gsub("total_", "", y_var)) +
        stat_cor(method = "pearson", label.x = min(merged_data[[x_var]], na.rm = TRUE), 
                 label.y = max(merged_data[[y_var]], na.rm = TRUE)) +
        theme_minimal()
    } else {
      p <- ggplot(merged_data, aes_string(x = x_var, y = y_var, color = group_var, label = "month_year")) +
        geom_point() +
        geom_smooth(method = "lm") +
        geom_text(check_overlap = TRUE, vjust = 1.5, size = 3) +
        labs(title = title, x = "Ticket Sales", y = gsub("total_", "", y_var)) +
        stat_cor(method = "pearson", aes_string(color = group_var), label.x = min(merged_data[[x_var]], na.rm = TRUE)) +
        theme_minimal()
    }
    print(p)
    Sys.sleep(1)
    return(cor_value)
  } else {
    cat(sprintf("%s - Insufficient data for correlation\n", title))
    return(NA)
  }
}


```





```{r}
# Prepare ticket_data with a month-year column
if(nrow(ticket_data) > 0) {
  ticket_data$date <- as.Date(paste(ticket_data$Year, ticket_data$Month, "01", sep = "-"), format = "%Y-%B-%d")
  ticket_data$month_year <- format(ticket_data$date, "%Y-%m")
  ticket_sum <- ticket_data %>% 
    group_by(month_year) %>% 
    summarise(total_tickets = sum(TicketSell, na.rm = TRUE))
}

# Prepare accommodation data and get unique Indicators
if(nrow(accom_data) > 0) {
  accom_data$month_year <- accom_data$`YYYY-MM`
  unique_indicators <- unique(accom_data$Indicator)
  num_indicators <- length(unique_indicators)
  cat(sprintf("Number of unique Indicators found: %d\n", num_indicators))
  
  # Limit to 18 or fewer indicators
  if(num_indicators > 18) {
    unique_indicators <- unique_indicators[1:18]
    cat("Limiting to first 18 Indicators.\n")
  }
} else {
  cat("No data in htaaccommodationchoices table.\n")
  unique_indicators <- character(0)
}

# Function to plot correlation for a specific Indicator
plot_correlation_by_indicator <- function(ticket_data, accom_data, indicator, plot_num) {
  # Filter accommodation data for the specific Indicator
  accom_subset <- accom_data %>% 
    filter(Indicator == indicator) %>% 
    group_by(month_year) %>% 
    summarise(total_accom = sum(value, na.rm = TRUE))
  
  # Merge with ticket data
  merged_data <- merge(ticket_data, accom_subset, by = "month_year", all = FALSE)
  
  if(nrow(merged_data) > 1) {  # Need at least 2 points for correlation
    # Calculate correlation
    cor_value <- cor(merged_data$total_tickets, merged_data$total_accom, use = "complete.obs", method = "pearson")
    cat(sprintf("Plot %d - Ticket Sales vs %s - Pearson Correlation: %.3f\n", plot_num, indicator, cor_value))
    
    # Create scatter plot
    p <- ggplot(merged_data, aes(x = total_tickets, y = total_accom)) +
      geom_point() +
      geom_smooth(method = "lm", color = "blue") +
      labs(title = sprintf("Plot %d: Ticket Sales vs Accommodation (%s)", plot_num, indicator),
           x = "Ticket Sales", y = paste("Accommodation Value (", indicator, ")")) +
      stat_cor(method = "pearson", label.x = min(merged_data$total_tickets, na.rm = TRUE), 
               label.y = max(merged_data$total_accom, na.rm = TRUE)) +
      theme_minimal()
    print(p)
    Sys.sleep(1)
    return(cor_value)
  } else {
    cat(sprintf("Plot %d - Ticket Sales vs %s - Insufficient data for correlation\n", plot_num, indicator))
    return(NA)
  }
}

```

```{r}

# Prepare ticket_data with a month-year column
if(nrow(ticket_data) > 0) {
  ticket_data$date <- as.Date(paste(ticket_data$Year, ticket_data$Month, "01", sep = "-"), format = "%Y-%B-%d")
  ticket_data$month_year <- format(ticket_data$date, "%Y-%m")
  ticket_sum <- ticket_data %>% 
    group_by(month_year) %>% 
    summarise(total_tickets = sum(TicketSell, na.rm = TRUE))
}

# Prepare purpose of trip data and get unique Indicators
if(nrow(purpose_data) > 0) {
  purpose_data$month_year <- purpose_data$`YYYY-MM`
  unique_indicators <- unique(purpose_data$Indicator)
  num_indicators <- length(unique_indicators)
  cat(sprintf("Number of unique Indicators found: %d\n", num_indicators))
  
  # Limit to 15 or fewer indicators
  if(num_indicators > 15) {
    unique_indicators <- unique_indicators[1:15]
    cat("Limiting to first 15 Indicators.\n")
  }
} else {
  cat("No data in htapurposeoftrip table.\n")
  unique_indicators <- character(0)
}

# Function to plot correlation for a specific Indicator
plot_correlation_by_indicator <- function(ticket_data, purpose_data, indicator, plot_num) {
  # Filter purpose data for the specific Indicator
  purpose_subset <- purpose_data %>% 
    filter(Indicator == indicator) %>% 
    group_by(month_year) %>% 
    summarise(total_purpose = sum(value, na.rm = TRUE))
  
  # Merge with ticket data
  merged_data <- merge(ticket_data, purpose_subset, by = "month_year", all = FALSE)
  
  if(nrow(merged_data) > 1) {  # Need at least 2 points for correlation
    # Calculate correlation
    cor_value <- cor(merged_data$total_tickets, merged_data$total_purpose, use = "complete.obs", method = "pearson")
    cat(sprintf("Plot %d - Ticket Sales vs %s - Pearson Correlation: %.3f\n", plot_num, indicator, cor_value))
    
    # Create scatter plot
    p <- ggplot(merged_data, aes(x = total_tickets, y = total_purpose)) +
      geom_point() +
      geom_smooth(method = "lm", color = "blue") +
      labs(title = sprintf("Plot %d: Ticket Sales vs Purpose of Trip (%s)", plot_num, indicator),
           x = "Ticket Sales", y = paste("Purpose Value (", indicator, ")")) +
      stat_cor(method = "pearson", label.x = min(merged_data$total_tickets, na.rm = TRUE), 
               label.y = max(merged_data$total_purpose, na.rm = TRUE)) +
      theme_minimal()
    print(p)
    Sys.sleep(1)
    return(cor_value)
  } else {
    cat(sprintf("Plot %d - Ticket Sales vs %s - Insufficient data for correlation\n", plot_num, indicator))
    return(NA)
  }
}

```


```{r}

# Ticket Sales vs Air Visitors (by Group)
if(nrow(air_data) > 0 && nrow(ticket_data) > 0) {
  air_sum <- air_data %>% 
    group_by(`YYYY-MM`) %>% 
    summarise(total_air = sum(value, na.rm = TRUE)) %>% 
    rename(month_year = `YYYY-MM`)
  cor_air <- plot_correlation(ticket_sum, air_sum, "total_tickets", "total_air", 
                             "Ticket Sales vs Air Visitors")
}

```

```{r}
# Disconnect from database
dbDisconnect(con)

```





